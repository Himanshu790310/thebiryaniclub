{% extends "base.html" %}

{% block title %}Order Tracking - Biryani Club{% endblock %}

{% block content %}
<div class="container py-4">
    {% if order %}
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Order Header -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col">
                            <h4 class="mb-0"><i class="fas fa-receipt"></i> Order {{ order.order_id }}</h4>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-light text-dark fs-6">
                                {{ order.get_status_display() }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Customer Information</h6>
                            <p class="mb-1"><strong>{{ order.customer_name }}</strong></p>
                            <p class="mb-1"><i class="fas fa-phone text-success"></i> {{ order.customer_phone }}</p>
                            <p class="mb-0"><i class="fas fa-map-marker-alt text-danger"></i> {{ order.customer_address }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Order Details</h6>
                            <p class="mb-1"><strong>Order ID:</strong> {{ order.order_id }}</p>
                            <p class="mb-1"><strong>Placed:</strong> {{ order.created_at.strftime('%d %B %Y, %I:%M %p') }}</p>
                            {% if order.estimated_delivery %}
                                <p class="mb-1"><strong>Estimated Delivery:</strong> {{ order.estimated_delivery.strftime('%I:%M %p') }}</p>
                            {% endif %}
                            <p class="mb-0"><strong>Payment:</strong> {{ order.payment_method.upper() }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Timeline -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-route"></i> Order Status</h5>
                </div>
                <div class="card-body">
                    <div class="order-timeline">
                        <div class="timeline-item {{ 'active' if order.status in ['pending', 'confirmed', 'preparing', 'out_for_delivery', 'delivered'] else '' }} {{ 'current' if order.status == 'pending' else '' }}">
                            <div class="timeline-content">
                                <h6>Order Received</h6>
                                <small class="text-muted">Your order has been received and is being processed</small>
                                {% if order.status == 'pending' %}
                                    <div class="mt-1">
                                        <small class="text-primary"><i class="fas fa-clock"></i> Current Status</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="timeline-item {{ 'active' if order.status in ['confirmed', 'preparing', 'out_for_delivery', 'delivered'] else '' }} {{ 'current' if order.status == 'confirmed' else '' }}">
                            <div class="timeline-content">
                                <h6>Order Confirmed</h6>
                                <small class="text-muted">Order confirmed and kitchen preparation will start soon</small>
                                {% if order.status == 'confirmed' %}
                                    <div class="mt-1">
                                        <small class="text-primary"><i class="fas fa-clock"></i> Current Status</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="timeline-item {{ 'active' if order.status in ['preparing', 'out_for_delivery', 'delivered'] else '' }} {{ 'current' if order.status == 'preparing' else '' }}">
                            <div class="timeline-content">
                                <h6>Being Prepared</h6>
                                <small class="text-muted">Your delicious food is being prepared with care</small>
                                {% if order.status == 'preparing' %}
                                    <div class="mt-1">
                                        <small class="text-primary"><i class="fas fa-utensils"></i> Kitchen is working on your order</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="timeline-item {{ 'active' if order.status in ['out_for_delivery', 'delivered'] else '' }} {{ 'current' if order.status == 'out_for_delivery' else '' }}">
                            <div class="timeline-content">
                                <h6>Out for Delivery</h6>
                                <small class="text-muted">Order is on the way to your location</small>
                                {% if order.status == 'out_for_delivery' %}
                                    <div class="mt-1">
                                        <small class="text-primary"><i class="fas fa-motorcycle"></i> 
                                            {% if order.delivery_person %}
                                                Delivery person: {{ order.delivery_person.full_name }}
                                            {% else %}
                                                Delivery person assigned
                                            {% endif %}
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="timeline-item {{ 'active' if order.status == 'delivered' else '' }} {{ 'current' if order.status == 'delivered' else '' }}">
                            <div class="timeline-content">
                                <h6>Delivered</h6>
                                <small class="text-muted">Order delivered successfully. Enjoy your meal!</small>
                                {% if order.status == 'delivered' %}
                                    <div class="mt-2">
                                        {% if order.rating %}
                                            <div class="mb-2">
                                                <strong>Your Rating:</strong>
                                                {% for i in range(1, 6) %}
                                                    <i class="fas fa-star {{ 'text-warning' if i <= order.rating else 'text-muted' }}"></i>
                                                {% endfor %}
                                            </div>
                                            {% if order.feedback %}
                                                <div>
                                                    <strong>Your Feedback:</strong>
                                                    <p class="text-muted mt-1">{{ order.feedback }}</p>
                                                </div>
                                            {% endif %}
                                        {% else %}
                                            <button class="btn btn-outline-primary btn-sm" onclick="openRatingModal()">
                                                <i class="fas fa-star"></i> Rate Order
                                            </button>
                                        {% endif %}
                                        
                                        {% if order.can_use_spin() %}
                                            <div class="mt-2">
                                                <a href="{{ url_for('customer.spin_wheel') }}" class="btn btn-warning btn-sm">
                                                    <i class="fas fa-gift"></i> Spin for Rewards!
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Items -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-shopping-bag"></i> Order Items</h5>
                </div>
                <div class="card-body">
                    {% set items = order.get_items() %}
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in items %}
                                <tr>
                                    <td>
                                        {{ item.emoji }} {{ item.name }}
                                        {% if item.get('is_free') %}
                                            <span class="badge bg-success">FREE</span>
                                        {% endif %}
                                    </td>
                                    <td>₹{{ item.price }}</td>
                                    <td>{{ item.quantity }}</td>
                                    <td>₹{{ item.price * item.quantity }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="3">Subtotal:</th>
                                    <th>₹{{ order.subtotal }}</th>
                                </tr>
                                {% if order.discount > 0 %}
                                <tr class="text-success">
                                    <th colspan="3">Discount:</th>
                                    <th>-₹{{ order.discount }}</th>
                                </tr>
                                {% endif %}
                                <tr class="table-success">
                                    <th colspan="3">Total Paid:</th>
                                    <th>₹{{ order.total }}</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    {% if order.coupon_code %}
                        <div class="alert alert-success">
                            <i class="fas fa-ticket-alt"></i> Coupon applied: <strong>{{ order.coupon_code }}</strong>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="text-center">
                <div class="btn-group flex-wrap gap-2">
                    <a href="{{ url_for('main.index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home"></i> Go Home
                    </a>
                    <a href="{{ url_for('customer.menu') }}" class="btn btn-primary">
                        <i class="fas fa-utensils"></i> Order Again
                    </a>
                    {% if order.status == 'delivered' and order.can_use_spin() %}
                        <a href="{{ url_for('customer.spin_wheel') }}" class="btn btn-warning">
                            <i class="fas fa-gift"></i> Spin for Rewards
                        </a>
                    {% endif %}
                    <a href="{{ url_for('support.contact') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-headset"></i> Need Help?
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Order not found -->
    <div class="row">
        <div class="col-md-6 mx-auto">
            <div class="text-center py-5">
                <i class="fas fa-search text-muted" style="font-size: 4rem;"></i>
                <h3 class="mt-3">Order Not Found</h3>
                <p class="text-muted">The order you're looking for doesn't exist or has been removed.</p>
                <a href="{{ url_for('main.index') }}" class="btn btn-primary">
                    <i class="fas fa-home"></i> Go Home
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Rating Modal -->
<div class="modal fade" id="rating-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-star text-warning"></i> Rate Your Order</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h6>How was your experience?</h6>
                    <div class="rating-stars">
                        {% for i in range(1, 6) %}
                        <i class="fas fa-star rating-star" data-rating="{{ i }}" style="font-size: 2rem; cursor: pointer; color: #ddd;"></i>
                        {% endfor %}
                    </div>
                </div>
                <div class="mb-3">
                    <label for="order-feedback" class="form-label">Feedback (Optional)</label>
                    <textarea class="form-control" id="order-feedback" rows="3" placeholder="Tell us about your experience..."></textarea>
                </div>
                <input type="hidden" id="order-rating" value="">
                <input type="hidden" id="rating-order-id" value="{{ order.order_id if order else '' }}">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRating()">Submit Rating</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function openRatingModal() {
    const modal = new bootstrap.Modal(document.getElementById('rating-modal'));
    modal.show();
}

// Rating star interaction
document.querySelectorAll('.rating-star').forEach(star => {
    star.addEventListener('mouseenter', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        highlightStars(rating);
    });
    
    star.addEventListener('mouseleave', function() {
        const selectedRating = document.getElementById('order-rating').value;
        highlightStars(selectedRating || 0);
    });
    
    star.addEventListener('click', function() {
        const rating = parseInt(this.getAttribute('data-rating'));
        document.getElementById('order-rating').value = rating;
        highlightStars(rating);
    });
});

function highlightStars(rating) {
    document.querySelectorAll('.rating-star').forEach((star, index) => {
        if (index < rating) {
            star.style.color = '#ffc107';
        } else {
            star.style.color = '#ddd';
        }
    });
}

function submitRating() {
    const orderId = document.getElementById('rating-order-id').value;
    const rating = document.getElementById('order-rating').value;
    const feedback = document.getElementById('order-feedback').value;
    
    if (!rating) {
        showNotification('Please select a rating', 'error');
        return;
    }
    
    fetch('/customer/rate_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            rating: parseInt(rating),
            feedback: feedback
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('rating-modal'));
            modal.hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Failed to submit rating', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to submit rating', 'error');
    });
}

// Auto refresh if order is not delivered yet
{% if order and order.status != 'delivered' %}
setInterval(() => {
    location.reload();
}, 30000); // Refresh every 30 seconds
{% endif %}
</script>

<style>
.order-timeline {
    position: relative;
    padding-left: 2rem;
}

.order-timeline::before {
    content: '';
    position: absolute;
    left: 10px;
    top: 0;
    height: 100%;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -25px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #e9ecef;
    border: 2px solid #fff;
}

.timeline-item.active::before {
    background: #28a745;
}

.timeline-item.current::before {
    background: #007bff;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(0, 123, 255, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 123, 255, 0); }
}

.timeline-content {
    padding-left: 1rem;
}
</style>
{% endblock %}
