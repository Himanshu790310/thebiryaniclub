{% extends "base.html" %}

{% block title %}Manage Orders - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-shopping-bag"></i> Manage Orders</h2>
                <div class="btn-group">
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                    <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Filter Tabs -->
    <div class="card mb-4">
        <div class="card-body">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'all' else '' }}" 
                       href="{{ url_for('admin.orders', status='all') }}">
                        All Orders
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'pending' else '' }}" 
                       href="{{ url_for('admin.orders', status='pending') }}">
                        <i class="fas fa-clock text-warning"></i> Pending
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'confirmed' else '' }}" 
                       href="{{ url_for('admin.orders', status='confirmed') }}">
                        <i class="fas fa-check-circle text-info"></i> Confirmed
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'preparing' else '' }}" 
                       href="{{ url_for('admin.orders', status='preparing') }}">
                        <i class="fas fa-utensils text-primary"></i> Preparing
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'out_for_delivery' else '' }}" 
                       href="{{ url_for('admin.orders', status='out_for_delivery') }}">
                        <i class="fas fa-motorcycle text-warning"></i> Out for Delivery
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'delivered' else '' }}" 
                       href="{{ url_for('admin.orders', status='delivered') }}">
                        <i class="fas fa-check text-success"></i> Delivered
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card">
        <div class="card-body">
            {% if orders.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Order Details</th>
                                <th>Customer Info</th>
                                <th>Items</th>
                                <th>Payment</th>
                                <th>Status</th>
                                <th>Timing</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in orders.items %}
                            <tr>
                                <td>
                                    <strong class="text-primary">{{ order.order_id }}</strong><br>
                                    {% if order.coupon_code %}
                                        <small class="badge bg-success">{{ order.coupon_code }}</small>
                                    {% endif %}
                                    {% if order.rating %}
                                        <div class="mt-1">
                                            {% for i in range(1, 6) %}
                                                <i class="fas fa-star {{ 'text-warning' if i <= order.rating else 'text-muted' }}"></i>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ order.customer_name }}</strong><br>
                                    <small class="text-muted">
                                        <i class="fas fa-phone"></i> {{ order.customer_phone }}<br>
                                        <i class="fas fa-map-marker-alt"></i> {{ order.customer_address[:50] }}...
                                    </small>
                                </td>
                                <td>
                                    {% set items = order.get_items() %}
                                    <div class="small">
                                        {% for item in items %}
                                            <div>{{ item.emoji }} {{ item.name }} × {{ item.quantity }}</div>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <strong class="text-success">₹{{ order.total }}</strong>
                                        {% if order.discount > 0 %}
                                            <br><small class="text-muted">Discount: -₹{{ order.discount }}</small>
                                        {% endif %}
                                    </div>
                                    <small class="badge bg-info">{{ order.payment_method|upper }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if order.status == 'delivered' else 'warning' if order.status in ['pending', 'confirmed'] else 'primary' }}">
                                        {{ order.get_status_display() }}
                                    </span>
                                    {% if order.delivery_person %}
                                        <br><small class="text-muted">
                                            <i class="fas fa-motorcycle"></i> {{ order.delivery_person.full_name }}
                                        </small>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>
                                        <strong>Ordered:</strong><br>
                                        {{ order.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
                                        {% if order.estimated_delivery %}
                                            <strong>ETA:</strong><br>
                                            {{ order.estimated_delivery.strftime('%H:%M') }}
                                        {% endif %}
                                    </small>
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm">
                                        <select class="form-select form-select-sm mb-1" onchange="updateOrderStatus('{{ order.order_id }}', this.value)">
                                            <option value="">Update Status</option>
                                            <option value="pending" {{ 'selected' if order.status == 'pending' else '' }}>Pending</option>
                                            <option value="confirmed" {{ 'selected' if order.status == 'confirmed' else '' }}>Confirmed</option>
                                            <option value="preparing" {{ 'selected' if order.status == 'preparing' else '' }}>Preparing</option>
                                            <option value="out_for_delivery" {{ 'selected' if order.status == 'out_for_delivery' else '' }}>Out for Delivery</option>
                                            <option value="delivered" {{ 'selected' if order.status == 'delivered' else '' }}>Delivered</option>
                                            <option value="cancelled" {{ 'selected' if order.status == 'cancelled' else '' }}>Cancelled</option>
                                        </select>
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewOrderDetails('{{ order.order_id }}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if orders.pages > 1 %}
                    <nav aria-label="Orders pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            {% if orders.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.orders', page=orders.prev_num, status=current_status) }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            {% for page_num in orders.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                {% if page_num %}
                                    {% if page_num != orders.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('admin.orders', page=page_num, status=current_status) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if orders.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('admin.orders', page=orders.next_num, status=current_status) }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-shopping-bag text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 text-muted">No Orders Found</h4>
                    <p class="text-muted">
                        {% if current_status == 'all' %}
                            No orders have been placed yet.
                        {% else %}
                            No orders with status "{{ current_status.replace('_', ' ').title() }}" found.
                        {% endif %}
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="order-details-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="order-details-content">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateOrderStatus(orderId, newStatus) {
    if (!newStatus) return;
    
    fetch('/admin/update_order_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            order_id: orderId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Order status updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error || 'Failed to update order status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to update order status', 'error');
    });
}

function viewOrderDetails(orderId) {
    fetch(`/api/order_status/${orderId}`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error');
            return;
        }
        
        let itemsHtml = '';
        data.items.forEach(item => {
            itemsHtml += `
                <tr>
                    <td>${item.emoji} ${item.name}</td>
                    <td>₹${item.price}</td>
                    <td>${item.quantity}</td>
                    <td>₹${item.price * item.quantity}</td>
                </tr>
            `;
        });
        
        const detailsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Order Information</h6>
                    <p><strong>Order ID:</strong> ${data.order_id}</p>
                    <p><strong>Status:</strong> <span class="badge bg-primary">${data.status_display}</span></p>
                    <p><strong>Placed:</strong> ${new Date(data.created_at).toLocaleString()}</p>
                    ${data.estimated_delivery ? `<p><strong>ETA:</strong> ${new Date(data.estimated_delivery).toLocaleString()}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6>Customer Information</h6>
                    <p><strong>Name:</strong> ${data.customer_name}</p>
                    <p><strong>Phone:</strong> ${data.customer_phone}</p>
                    <p><strong>Address:</strong> ${data.customer_address}</p>
                </div>
            </div>
            
            <h6 class="mt-3">Order Items</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Price</th>
                            <th>Qty</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    ${data.feedback ? `
                        <h6>Customer Feedback</h6>
                        <div class="mb-2">
                            ${Array.from({length: 5}, (_, i) => 
                                `<i class="fas fa-star ${i < data.rating ? 'text-warning' : 'text-muted'}"></i>`
                            ).join('')}
                        </div>
                        <p class="text-muted">${data.feedback}</p>
                    ` : ''}
                </div>
                <div class="col-md-6 text-end">
                    <p><strong>Subtotal:</strong> ₹${data.subtotal}</p>
                    ${data.discount > 0 ? `<p><strong>Discount:</strong> -₹${data.discount}</p>` : ''}
                    <h5><strong>Total: ₹${data.total}</strong></h5>
                </div>
            </div>
        `;
        
        document.getElementById('order-details-content').innerHTML = detailsHtml;
        const modal = new bootstrap.Modal(document.getElementById('order-details-modal'));
        modal.show();
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to load order details', 'error');
    });
}
</script>
{% endblock %}
