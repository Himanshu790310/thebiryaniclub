{% extends "base.html" %}

{% block title %}Support Tickets - Admin Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-ticket-alt"></i> Support Tickets</h2>
                <div class="btn-group">
                    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                    <a href="{{ url_for('main.logout') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Filter Tabs -->
    <div class="card mb-4">
        <div class="card-body">
            <ul class="nav nav-pills">
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'open' else '' }}" 
                       href="{{ url_for('admin.support_tickets', status='open') }}">
                        <i class="fas fa-folder-open text-warning"></i> Open
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'in_progress' else '' }}" 
                       href="{{ url_for('admin.support_tickets', status='in_progress') }}">
                        <i class="fas fa-spinner text-primary"></i> In Progress
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'resolved' else '' }}" 
                       href="{{ url_for('admin.support_tickets', status='resolved') }}">
                        <i class="fas fa-check-circle text-success"></i> Resolved
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {{ 'active' if current_status == 'closed' else '' }}" 
                       href="{{ url_for('admin.support_tickets', status='closed') }}">
                        <i class="fas fa-times-circle text-muted"></i> Closed
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Support Tickets -->
    <div class="row">
        {% if tickets %}
            {% for ticket in tickets %}
            <div class="col-lg-6 mb-4">
                <div class="card h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="text-primary">{{ ticket.ticket_id }}</strong>
                            <span class="badge bg-{{ 'danger' if ticket.priority == 'urgent' else 'warning' if ticket.priority == 'high' else 'info' if ticket.priority == 'medium' else 'secondary' }}">
                                {{ ticket.priority|upper }}
                            </span>
                        </div>
                        <span class="badge bg-{{ 'warning' if ticket.status == 'open' else 'primary' if ticket.status == 'in_progress' else 'success' if ticket.status == 'resolved' else 'secondary' }}">
                            {{ ticket.get_status_display() }}
                        </span>
                    </div>
                    <div class="card-body">
                        <h6>{{ ticket.subject }}</h6>
                        <p class="text-muted small mb-2">{{ ticket.description[:150] }}...</p>
                        
                        <div class="row text-sm">
                            <div class="col-6">
                                <small>
                                    <strong>Customer:</strong><br>
                                    {{ ticket.customer_name }}<br>
                                    <i class="fas fa-phone"></i> {{ ticket.customer_phone }}
                                    {% if ticket.customer_email %}
                                        <br><i class="fas fa-envelope"></i> {{ ticket.customer_email }}
                                    {% endif %}
                                </small>
                            </div>
                            <div class="col-6">
                                <small>
                                    <strong>Details:</strong><br>
                                    Category: {{ ticket.category.replace('_', ' ')|title }}<br>
                                    {% if ticket.order_id %}
                                        Order: {{ ticket.order_id }}<br>
                                    {% endif %}
                                    Created: {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-8">
                                <select class="form-select form-select-sm" onchange="updateTicketStatus('{{ ticket.ticket_id }}', this.value)">
                                    <option value="">Update Status</option>
                                    <option value="open" {{ 'selected' if ticket.status == 'open' else '' }}>Open</option>
                                    <option value="in_progress" {{ 'selected' if ticket.status == 'in_progress' else '' }}>In Progress</option>
                                    <option value="resolved" {{ 'selected' if ticket.status == 'resolved' else '' }}>Resolved</option>
                                    <option value="closed" {{ 'selected' if ticket.status == 'closed' else '' }}>Closed</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-outline-primary btn-sm w-100" onclick="viewTicketDetails('{{ ticket.ticket_id }}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="fas fa-ticket-alt text-muted" style="font-size: 4rem;"></i>
                    <h4 class="mt-3 text-muted">No Support Tickets</h4>
                    <p class="text-muted">
                        {% if current_status == 'all' %}
                            No support tickets have been created yet.
                        {% else %}
                            No "{{ current_status.replace('_', ' ').title() }}" tickets found.
                        {% endif %}
                    </p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Ticket Details Modal -->
<div class="modal fade" id="ticket-details-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ticket Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ticket-details-content">
                <!-- Ticket details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveTicketNotes()">Save Notes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateTicketStatus(ticketId, newStatus) {
    if (!newStatus) return;
    
    fetch('/admin/update_ticket_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ticket_id: ticketId,
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Ticket status updated successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error || 'Failed to update ticket status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to update ticket status', 'error');
    });
}

let currentTicketId = null;

function viewTicketDetails(ticketId) {
    currentTicketId = ticketId;
    
    // Find ticket in current page data (you might want to fetch from server instead)
    const tickets = {{ tickets|tojson }};
    const ticket = tickets.find(t => t.ticket_id === ticketId);
    
    if (!ticket) {
        showNotification('Ticket not found', 'error');
        return;
    }
    
    const detailsHtml = `
        <div class="row">
            <div class="col-md-6">
                <h6>Ticket Information</h6>
                <p><strong>Ticket ID:</strong> ${ticket.ticket_id}</p>
                <p><strong>Status:</strong> <span class="badge bg-primary">${ticket.status_display}</span></p>
                <p><strong>Priority:</strong> <span class="badge bg-warning">${ticket.priority.toUpperCase()}</span></p>
                <p><strong>Category:</strong> ${ticket.category.replace('_', ' ')}</p>
                <p><strong>Created:</strong> ${new Date(ticket.created_at).toLocaleString()}</p>
                ${ticket.resolved_at ? `<p><strong>Resolved:</strong> ${new Date(ticket.resolved_at).toLocaleString()}</p>` : ''}
            </div>
            <div class="col-md-6">
                <h6>Customer Information</h6>
                <p><strong>Name:</strong> ${ticket.customer_name}</p>
                <p><strong>Phone:</strong> ${ticket.customer_phone}</p>
                ${ticket.customer_email ? `<p><strong>Email:</strong> ${ticket.customer_email}</p>` : ''}
                ${ticket.order_id ? `<p><strong>Order ID:</strong> ${ticket.order_id}</p>` : ''}
            </div>
        </div>
        
        <div class="mt-3">
            <h6>Subject</h6>
            <p>${ticket.subject}</p>
            
            <h6>Description</h6>
            <p class="text-muted">${ticket.description}</p>
            
            <h6>Admin Notes</h6>
            <textarea class="form-control" id="admin-notes" rows="4" placeholder="Add your notes here...">${ticket.admin_notes || ''}</textarea>
        </div>
    `;
    
    document.getElementById('ticket-details-content').innerHTML = detailsHtml;
    const modal = new bootstrap.Modal(document.getElementById('ticket-details-modal'));
    modal.show();
}

function saveTicketNotes() {
    if (!currentTicketId) return;
    
    const adminNotes = document.getElementById('admin-notes').value;
    
    fetch('/admin/update_ticket_status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            ticket_id: currentTicketId,
            admin_notes: adminNotes,
            status: 'in_progress' // Assume updating notes means ticket is being worked on
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Notes saved successfully', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('ticket-details-modal'));
            modal.hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showNotification(data.error || 'Failed to save notes', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Failed to save notes', 'error');
    });
}
</script>
{% endblock %}
